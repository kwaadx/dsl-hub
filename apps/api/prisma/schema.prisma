generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Flow {
  id          String       @id @default(cuid())
  name        String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  threads     Thread[]
  pipelines   Pipeline[]
  summaries   FlowSummary[]
  logs        AgentLog[]
}

enum ThreadStatus {
  NEW
  IN_PROGRESS
  SUCCESS
  FAILED
  ARCHIVED
}

model Thread {
  id         String        @id @default(cuid())
  flowId     String
  flow       Flow          @relation(fields: [flowId], references: [id])
  status     ThreadStatus  @default(NEW)
  archived   Boolean       @default(false)
  archivedAt DateTime?
  startedAt  DateTime      @default(now())
  closedAt   DateTime?
  updatedAt  DateTime      @updatedAt
  messages   Message[]
  logs       AgentLog[]

  @@index([flowId])
  @@index([status])
  @@index([archived, archivedAt])
}

enum MessageRole {
  user
  assistant
  system
  tool
}

enum MessageFormat {
  text
  markdown
  json
  buttons
  card
}

model Message {
  id        String        @id @default(cuid())
  threadId  String
  thread    Thread        @relation(fields: [threadId], references: [id])
  role      MessageRole
  format    MessageFormat @default(text)
  content   Json
  createdAt DateTime      @default(now())

  @@index([threadId])
  @@index([createdAt])
}

model Pipeline {
  id            String   @id @default(cuid())
  flowId        String
  flow          Flow     @relation(fields: [flowId], references: [id])
  version       String
  schemaVersion String
  status        String   @default("draft")
  content       Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([flowId])
  @@index([createdAt])
}

model SchemaDef {
  id        String   @id @default(cuid())
  name      String
  version   String
  json      Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name, version])
}

model FlowSummary {
  id        String   @id @default(cuid())
  flowId    String
  flow      Flow     @relation(fields: [flowId], references: [id])
  version   Int      @default(1)
  content   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([flowId])
  @@index([updatedAt])
}

model GlobalSummary {
  id        String   @id @default(cuid())
  content   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AgentLog {
  id        String   @id @default(cuid())
  flowId    String?
  threadId  String?
  level     String
  event     String
  data      Json?
  createdAt DateTime @default(now())

  flow   Flow?   @relation(fields: [flowId], references: [id])
  thread Thread? @relation(fields: [threadId], references: [id])

  @@index([flowId])
  @@index([threadId])
  @@index([createdAt])
}
